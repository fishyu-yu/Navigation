<%- include('partials/header') %>
  <section class="auth">
    <div class="auth-header">
      <h1 class="title">管理员登录</h1>
      <a href="/" class="back-to-home">
        <i class="fas fa-arrow-left"></i>
        返回首页
      </a>
    </div>
    <% if (error) { %>
      <div class="alert"><%= error %></div>
    <% } %>
    <form class="form" method="post" action="/login" id="loginForm">
      <label class="field">
        <span>用户名</span>
        <input name="username" required />
      </label>
      <label class="field">
        <span>密码</span>
        <input name="password" type="password" required />
      </label>
      
      <!-- 验证码容器 -->
      <div id="captcha-container"></div>
      
      <!-- 验证码响应隐藏字段 -->
      <input type="hidden" name="captcha_response" id="captcha_response" />
      
      <button class="btn primary" type="submit">登录</button>
    </form>
  </section>
  <script src="/captcha.js"></script>
  <script>
    // 初始化验证码
    let captchaInstance;
    
    document.addEventListener('DOMContentLoaded', async function() {
       try {
         // 从服务器获取验证码配置
         const response = await fetch('/api/captcha/config');
         const serverConfig = await response.json();
         
         const captchaConfig = {
           provider: serverConfig.provider,
           siteKey: serverConfig.siteKey,
           enabled: serverConfig.enabled,
           containerId: 'captcha-container'
         };
         
         captchaInstance = new CaptchaManager(captchaConfig);
       } catch (error) {
         console.error('获取验证码配置失败:', error);
         // 降级到默认配置
         captchaInstance = new CaptchaManager({
           provider: 'recaptcha',
           siteKey: '',
           enabled: false,
           containerId: 'captcha-container'
         });
       }
      
      // 监听验证码事件
      document.addEventListener('captcha:success', function(e) {
        console.log('验证码验证成功:', e.detail);
        // 移除可能存在的错误提示
        const errorAlert = document.querySelector('.captcha-error-alert');
        if (errorAlert) {
          errorAlert.remove();
        }
      });
      
      document.addEventListener('captcha:expired', function(e) {
        console.log('验证码已过期');
        showCaptchaError('验证码已过期，请重新验证');
      });
      
      document.addEventListener('captcha:error', function(e) {
        console.error('验证码错误:', e.detail);
        showCaptchaError('验证码加载失败，请刷新页面重试');
      });
      
      // 显示验证码错误信息
      function showCaptchaError(message) {
        // 移除之前的错误提示
        const existingError = document.querySelector('.captcha-error-alert');
        if (existingError) {
          existingError.remove();
        }
        
        // 创建新的错误提示
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert captcha-error-alert';
        errorDiv.style.cssText = 'background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; margin: 10px 0;';
        errorDiv.innerHTML = `
          <i class="fas fa-exclamation-triangle"></i>
          ${message}
          <button type="button" onclick="location.reload()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">重新加载</button>
        `;
        
        // 插入到验证码容器后面
        const captchaContainer = document.getElementById('captcha-container');
        if (captchaContainer && captchaContainer.parentNode) {
          captchaContainer.parentNode.insertBefore(errorDiv, captchaContainer.nextSibling);
        }
      }
    });
    
    // 表单提交验证
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      // 获取验证码响应并填入隐藏字段
      const captchaResponseField = document.getElementById('captcha_response');
      if (captchaInstance && captchaInstance.enabled) {
        const response = captchaInstance.getResponse();
        console.log('[Login] 验证码响应:', response ? '已获取' : '未获取', response);
        captchaResponseField.value = response || '';
        
        if (!response) {
          e.preventDefault();
          alert('请完成人机验证');
          return false;
        }
      } else {
        console.log('[Login] 验证码未启用');
        // 验证码未启用时清空字段
        captchaResponseField.value = '';
      }
    });
  </script>
<%- include('partials/footer') %>