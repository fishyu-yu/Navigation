<%- include('partials/header') %>
  <section class="auth">
    <div class="auth-header">
      <h1 class="title">管理员登录</h1>
      <a href="/" class="back-to-home">
        <i class="fas fa-arrow-left"></i>
        返回首页
      </a>
    </div>
    <% if (error) { %>
      <div class="alert"><%= error %></div>
    <% } %>
    <form class="form" method="post" action="/login">
      <label class="field">
        <span>用户名</span>
        <input name="username" required />
      </label>
      <label class="field">
        <span>密码</span>
        <input name="password" type="password" required />
      </label>
      
      <!-- 验证码容器 -->
      <div id="captcha-container"></div>
      
      <button class="btn primary" type="submit">登录</button>
    </form>
  </section>
  <script src="/captcha.js"></script>
  <script>
    // 初始化验证码
    let captchaInstance;
    
    document.addEventListener('DOMContentLoaded', async function() {
       try {
         // 从服务器获取验证码配置
         const response = await fetch('/api/captcha/config');
         const serverConfig = await response.json();
         
         const captchaConfig = {
           provider: serverConfig.provider,
           siteKey: serverConfig.siteKey,
           enabled: serverConfig.enabled,
           containerId: 'captcha-container'
         };
         
         captchaInstance = new CaptchaManager(captchaConfig);
       } catch (error) {
         console.error('获取验证码配置失败:', error);
         // 降级到默认配置
         captchaInstance = new CaptchaManager({
           provider: 'recaptcha',
           siteKey: '',
           enabled: false,
           containerId: 'captcha-container'
         });
       }
      
      // 监听验证码事件
      document.addEventListener('captcha:success', function(e) {
        console.log('验证码验证成功:', e.detail);
      });
      
      document.addEventListener('captcha:expired', function(e) {
        console.log('验证码已过期');
      });
      
      document.addEventListener('captcha:error', function(e) {
        console.error('验证码错误:', e.detail);
      });
    });
    
    // 表单提交验证
    document.querySelector('form').addEventListener('submit', function(e) {
      if (!validateCaptcha(captchaInstance)) {
        e.preventDefault();
        return false;
      }
      
      // 如果验证码启用，将响应添加到表单数据中
      if (captchaInstance && captchaInstance.enabled) {
        const response = captchaInstance.getResponse();
        if (response) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'captcha_response';
          input.value = response;
          this.appendChild(input);
        }
      }
    });
  </script>
<%- include('partials/footer') %>